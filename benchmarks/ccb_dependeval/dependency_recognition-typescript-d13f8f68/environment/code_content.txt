'installer-gui/frontend/components/App.tsx'
:import Preact, {Component} from "preact";
import InstallPage from "./actions/install";
import UninstallPage from "./actions/uninstall";
import UpdatePage from "./actions/update";
import AppContext from "./AppContext";
import Category from "./category";
import Install from "./icons/install";
import Uninstall from "./icons/uninstall";
import Update from "./icons/update";
import {Notifications} from "./notifications";
import TitleBar from "./titlebar";

export default class App extends Component {
    state = {navigator: {}}

    handleSetPage({element, title}): void {
        this.setState({
            navigator: {element, title}
        });
    }

    handleReset(): void {
        this.setState({navigator: {}});
    }

    renderHome() {
        return (
            <div class="form">
                <div class="form-title">Actions</div>
                <Category title="Install" icon={Install} note="Install kernel to an application you choose.">
                    <InstallPage />
                </Category>
                <Category title="Uninstall" icon={Uninstall} note="Uninstall kernel from an application you choose.">
                    <UninstallPage />
                </Category>
                <Category title="Update" icon={Update} note="Update the kernel.asar to the latest release.">
                    <UpdatePage />
                </Category>
            </div>
        );
    }

    render(_, {navigator}) {
        const context = {
            currentPage: navigator,
            setPage: this.handleSetPage.bind(this),
            reset: this.handleReset.bind(this)
        };

        return (
            <AppContext.Provider value={context}>
                <div id="app-mount">
                    <TitleBar />
                    <div class="app">
                        {navigator.element ? navigator.element : this.renderHome()}
                    </div>
                    <Notifications />
                </div>
            </AppContext.Provider>
        );
    }
}
'installer-gui/frontend/components/actions/uninstall.tsx'
:import Preact, {Component} from "preact";
import AppContext from "../AppContext";
import FileInput from "../fileinput";
import "./install.scss";
import SuggestedApplications from "./suggested";
import path from "path";
import fs from "fs";
import NotificationsStore from "../notifications";
import Terminal from "../terminal";
import {ipcRenderer as IPC} from "electron";
import IPCEvents from "@common/ipcevents";
import Uninstaller from "../../modules/uninstaller";

export default class UninstallPage extends Component<{}, {
    files: string[],
    isBrowsing: boolean,
    kernelPath: string,
    uninstallDone: boolean;
}> {
    fileInputRef = Preact.createRef();
    terminalRef = Preact.createRef<Terminal>();

    state = {
        files: [],
        isBrowsing: true,
        kernelPath: "",
        uninstallDone: false
    };

    handleChange = (files: string[]): void => {
        for (let i = 0; i < files.length; i++) {
            if (this.state.files.includes(files[i])) {
                files.splice(i, 1);
                continue;
            }

            const location = path.resolve(files[i], "resources");
            if (!fs.existsSync(location)) {
                files.splice(i, 1);
                NotificationsStore.showNotification("An invalid directory was given!");
            }
        }

        this.setState({
            files: this.state.files.concat(files)
        });
    }

    handleKernelPath = () => {}

    get canInstall() {
        return this.state.files.length > 0;
    }

    renderBrowser() {
        return (
            <>
                <FileInput
                    title="Applications to uninstall kernel from"
                    name="Uninstall paths"
                    files={this.state.files}
                    onChange={(files) => this.handleChange(files)}
                    onRemove={(path) => {
                        this.setState(prev => {
                            prev.files.splice(prev.files.indexOf(path), 1);
                            return {...prev, files: prev.files};
                        });
                    }}
                />
                <SuggestedApplications
                    onSelect={app => {
                        this.handleChange([app]);
                    }}
                    files={this.state.files}
                />
            </>
        );
    }

    renderInstalling() {
        return (
            <div class="form">
                <div class="form-title">Uninstall Kernel</div>
                <Terminal ref={this.terminalRef} />
            </div>
        );
    }

    handleInstall() {
        Uninstaller.uninstall(this.state.files, message => {
            this.terminalRef.current?.send(message);
        }).then(() => {
            this.setState({uninstallDone: true});
        });
    }

    render(_, {isBrowsing, uninstallDone}) {
        return (
            <AppContext.Consumer>
                {App => (
                    <div class="installing">
                        <div class="scroller">
                            {isBrowsing ? this.renderBrowser() : this.renderInstalling()}
                            <div class="margin-bottom10" />
                        </div>
                        <div class="footer">
                            <button onClick={() => {
                                if (isBrowsing) App.reset();
                                else this.setState({isBrowsing: true});
                            }}>Back</button>
                            <button
                                disabled={!this.canInstall}
                                onClick={() => {
                                    if (!this.canInstall) return;

                                    if (uninstallDone) return IPC.send(IPCEvents.CLOSE_APP);
                                    if (!isBrowsing) {
                                        this.handleInstall();
                                    } else {
                                        this.setState({isBrowsing: false});
                                    }
                                }}
                            >
                                {isBrowsing ? "Continue" : uninstallDone ? "Close" : "Uninstall"}
                            </button>
                        </div>
                    </div>
                )}
            </AppContext.Consumer>
        );
    }
}
'installer-gui/frontend/components/actions/suggested.tsx'
:import Preact, {Component} from "preact";

import path from "path";

import fs from "fs";

import Add from "../icons/add";

import "./suggested.scss";



const validateDirectory = (path: string) => fs.existsSync(path) && fs.statSync(path).isDirectory();

const capitalize = (str: string) => str[0].toUpperCase() + str.slice(1);

const sum = (...numbers) => numbers.reduce((full, num) => full += Number(num));

const extractVersion = (str: string) => sum(...str.slice("app-".length).split("."));



const AppData = process.env.LOCALAPPDATA ?? path.join(process.env.USERPROFILE ?? "/", "AppData", "Local");

const ProgramData = process.env.ProgramData ?? path.join("C:", "ProgramData");



const makeDiscordPath = (type: "canary" | "stable" | "ptb" | "development") => ({

    id: type === "stable" ? "Discord" : `Discord${capitalize(type)}`,

    name: `Discord ${type === "stable" ? "" : type === "ptb" ? "PTB" : capitalize(type)}`,

    get icon() {

        if (this._icon) return this._icon;

        let location = path.resolve(AppData, this.id, "app.ico");

        if (!fs.existsSync(location)) location = path.resolve(ProgramData, this.id, "app.ico");

        if (!fs.existsSync(location)) return "";

        return this._icon = ("data:image/x-icon;base64," + fs.readFileSync(location).toString("base64"));

    },

    get path() {

        if (this._path) return this._path;



        let location = path.resolve(AppData ?? "", this.id);



        if (!validateDirectory(location)) location = path.resolve(ProgramData, this.id);

        if (!validateDirectory(location)) return "";



        const appFolder = fs.readdirSync(location, "utf8")

            .filter(e => e.startsWith("app-") && validateDirectory(path.resolve(location, e)))

            .sort((a, b) => extractVersion(b) - extractVersion(a))[0];



        if (!appFolder) return null;



        return this._path = path.resolve(location, appFolder);

    }

});



const knownApplications = {

    Discord: makeDiscordPath("stable"),

    DiscordPTB: makeDiscordPath("ptb"),

    DiscordCanary: makeDiscordPath("canary"),

    DiscordDevelopment: makeDiscordPath("development")

};



export default class SuggestedApplications extends Component<{onSelect(app: string): void, files: string[]}> {

    renderApplication = (app: typeof knownApplications[keyof typeof knownApplications]) => {

        if (!app.path) return null;



        return (

            <div class={`application${this.props.files.includes(app.path) ? " disabled" : ""}`} key={app.name}>

                <img src={app.icon} class="app-icon" />

                <div class="app-container">

                    <div class="app-name">{app.name}</div>

                    <div class="app-path">{app.path}</div>

                </div>

                <button class="inline app-add" onClick={this.props.onSelect.bind(null, app.path)}>

                    <Add />

                </button>

            </div>

        );

    }



    render() {

        return (

            <div class="form">

                <div class="form-title">Suggested Appplications</div>

                {Object.values(knownApplications).map(this.renderApplication)}

            </div>

        )

    }

}
'installer-gui/frontend/index.ts'
:import {h, render} from "preact";
import App from "./components/App";
import Styles from "./styles";
import {createElement} from "./util";
import "./index.scss";

Styles.inject();
const root = createElement("div", {id: "root"});
document.body.appendChild(root);

render(
    h(App, {}),
    root
);