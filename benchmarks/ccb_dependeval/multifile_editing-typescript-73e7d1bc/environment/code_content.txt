'event-sourcing-demo-app/backend/src/domain/port/events/ShipUndockedEvent.ts'
:import { Event } from '@irontitan/paradox'
import { Port } from '../entity'
import { ObjectId } from 'mongodb'

interface IEventCreationParams {
  shipId: ObjectId,
  reason: string
}

export class ShipUndockedEvent extends Event<IEventCreationParams> {
  static readonly eventName = 'ship-was-undocked'
  readonly user: string

  constructor (data: IEventCreationParams, user: string) {
    super(ShipUndockedEvent.eventName, data)
    this.user = user
  }

  static commit (state: Port, event: ShipUndockedEvent): Port {
    state.dockedShips = state.dockedShips.filter((shipId) => !event.data.shipId.equals(shipId))
    state.updatedAt = event.timestamp
    state.updatedBy = event.user
    return state
  }
}

'event-sourcing-demo-app/backend/src/domain/port/entity.ts'
:import { ObjectId } from 'mongodb'
import { EventEntity } from '@irontitan/paradox'
import { PortWasCreatedEvent } from './events/PortWasCreatedEvent'
import { IPortCreationParams } from '../structures/IPortCreationParams'
import { Ship } from '../ship/entity'
import { ShipUndockedEvent } from './events/ShipUndockedEvent'
import { ShipDockedEvent } from './events/ShipDockedEvent'
import { PortWasDeletedEvent } from './events/PortWasDeletedEvent'

export class Port extends EventEntity<Port> {
  public id: ObjectId | null = null
  public name: string | null = null
  public dockedShips: ObjectId[] = []
  public createdAt: Date | null = null
  public createdBy: string | null = null
  public updatedAt: Date | null = null
  public updatedBy: string | null = null
  public deletedAt: Date | null = null
  public deletedBy: string | null = null

  static readonly collection = 'ports'

  constructor () {
    super({
      [PortWasCreatedEvent.eventName]: PortWasCreatedEvent.commit,
      [ShipUndockedEvent.eventName]: ShipUndockedEvent.commit,
      [ShipDockedEvent.eventName]: ShipDockedEvent.commit,
      [PortWasDeletedEvent.eventName]: PortWasDeletedEvent.commit
    })
  }

  static create (params: IPortCreationParams, user: string): Port {
    const port = new Port()

    port.pushNewEvents([
      new PortWasCreatedEvent({ id: new ObjectId(), ...params }, user)
    ])

    return port
  }

  undockShip (ship: Ship, reason: string, user: string): Port {
    this.pushNewEvents([
      new ShipUndockedEvent({ shipId: ship.id as ObjectId, reason }, user)
    ])

    return this
  }

  dockShip (ship: Ship, user: string): Port {
    this.pushNewEvents([
      new ShipDockedEvent({ shipId: ship.id as ObjectId }, user)
    ])

    return this
  }

  delete (user: string) {
    this.pushNewEvents([
      new PortWasDeletedEvent(user)
    ])

    return this
  }

  get state () {
    const currentState = this.reducer.reduce(new Port(), [
      ...this.persistedEvents,
      ...this.pendingEvents
    ])

    return {
      id: currentState.id,
      name: currentState.name,
      dockedShips: currentState.dockedShips,
      createdAt: currentState.createdAt,
      createdBy: currentState.createdBy,
      updatedAt: currentState.updatedAt,
      updatedBy: currentState.updatedBy,
      deletedAt: currentState.deletedAt,
      deletedBy: currentState.deletedBy
    }
  }
}

'event-sourcing-demo-app/backend/src/domain/port/events/PortWasCreatedEvent.ts'
:import { Event } from '@irontitan/paradox'
import { ObjectId } from 'mongodb'
import { Port } from '../entity'
import { IPortCreationParams } from '../../structures/IPortCreationParams'

interface IEventCreationParams extends IPortCreationParams {
  id: ObjectId
}

export class PortWasCreatedEvent extends Event<IEventCreationParams> {
  static readonly eventName = 'port-was-created'
  readonly user: string

  constructor (data: IEventCreationParams, user: string) {
    super(PortWasCreatedEvent.eventName, data)
    this.user = user
  }

  static commit (state: Port, event: PortWasCreatedEvent): Port {
    state.id = event.data.id
    state.name = event.data.name
    state.dockedShips = event.data.dockedShips.map((shipId) => new ObjectId(shipId))
    state.createdAt = event.timestamp
    state.createdBy = event.user
    state.updatedAt = event.timestamp
    state.updatedBy = event.user
    return state
  }
}

