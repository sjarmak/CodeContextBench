## Codebase Patterns
- Main artifact: ~/.claude/tom/transcript_memory.py (single file, ~800-1000 lines, zero external deps)
- Database: ~/.claude/tom/transcript-memory.db (SQLite with WAL mode and FTS5)
- JSONL transcripts: ~/.claude/projects/{project-name}/*.jsonl — each line is JSON with "type" field (user|assistant|progress)
- Session index: ~/.claude/projects/{project-name}/sessions-index.json — pre-computed metadata
- Subagent transcripts: ~/.claude/projects/{project-name}/{session-uuid}/subagents/agent-*.jsonl
- Tool calls in assistant messages: message.content[] with type=="tool_use", fields: id, name, input
- Tool results in user messages: message.content[] with type=="tool_result", fields: tool_use_id, content, is_error
- Match tool results to calls via tool_use_id field
- Assistant reasoning text: message.content[] with type=="text", field: text
- Token usage: message.usage.{input_tokens, output_tokens, cache_read_input_tokens}
- Timestamps: ISO 8601 with Z suffix on every entry
- Entry metadata: uuid, parentUuid, sessionId, cwd, gitBranch, agentId (for subagents)
- Secret redaction patterns (14): sk-*, ghp_*, gho_*, ghs_*, github_pat_*, Bearer *, Basic *, token *, xox*, AKIA*, eyJ*, password*, npm_*, pypi-*
- Existing ToM bootstrap: ~/.claude/tom/bootstrap_tom.py has ToM schema formats (SessionLog, SessionModel, UserModel, BM25)
- PRD with full SQL schema: tasks/prd-transcript-memory.md lines 210-324

## Progress

## 2026-02-07 - US-001: SQLite schema, DB init, and core TranscriptDB class
- Created ~/.claude/tom/transcript_memory.py (~260 lines) with full schema from PRD
- TranscriptDB class with context manager (__enter__/__exit__), WAL mode, FTS5
- 6 core tables: sessions, messages, tool_calls, session_summaries, decisions, ingest_state
- 3 FTS5 virtual tables: tool_calls_fts, summaries_fts, decisions_fts
- 10 indexes matching PRD spec exactly
- argparse CLI with all 8 subcommands: stats, ingest, search, sessions, decisions, tools, daemon, export-tom
- Stats command works: creates DB and prints counts
- Stub methods for all future story features
- **Learnings for future iterations:**
  - No sqlite3 CLI on this machine — verify DB with python3 instead
  - FTS5 content tables (e.g., tool_calls_fts) create _config, _data, _docsize, _idx auxiliary tables automatically
  - File lives OUTSIDE git repo at ~/.claude/tom/ — only ralph-tm/ files get committed
  - SCHEMA_SQL uses IF NOT EXISTS everywhere for idempotent re-runs
---
