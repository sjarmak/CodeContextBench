## Codebase Patterns
- instruction.md files are shared across all configs (baseline, SG_base, SG_full). MCP instructions are added via the SG preamble in claude_baseline_agent.py, NOT in instruction.md
- __archived_invalid/ is the convention for moving invalid runs within their batch directory
- runs/official/archive/ is for moving entire superseded batch directories
- status_fingerprints.py FINGERPRINTS dict uses regex patterns; aggregate_status.py imports them
- check_infra.py uses section-based checks with PASS/WARN/FAIL output
- archive_run.py has dry-run by default, --execute to actually archive
- generate_manifest.py scans runs/official/ for result.json, skips archive/ and __archived_invalid/
- LargeRepo task.toml pre_fix_rev values: now pinned — k8s=v1.30.0, vsc=1.96.0, servo+trt=commit hashes. Dockerfiles use `--filter=blob:none --no-checkout` + `git checkout <rev>`
- configs/instance_to_mirror.json maps task IDs to Sourcegraph mirror repo names with commit suffixes
- RepoQA instructions at benchmarks/ccb_repoqa/tasks/*/instruction.md
- TAC instructions at benchmarks/ccb_tac/*/instruction.md (6 active tasks)
- LargeRepo instructions at benchmarks/ccb_largerepo/*/instruction.md (4 tasks)
- SWE-bench Pro gap-fill instructions at benchmarks/ccb_swebenchpro/tasks/*/instruction.md
- K8s Docs instructions at benchmarks/ccb_k8sdocs/*/instruction.md (5 tasks)
- PyTorch instructions at benchmarks/ccb_pytorch/sgt-*/instruction.md (25 tasks)
- SWE-bench Pro has 731+ generated task instruction.md files with baked-in SG preamble separate from the template
- .gitignore has `tasks/` and `ralph/` patterns — benchmark task files and ralph/ files need `git add -f`
- Edit tool edits can be silently reverted by linter hooks — always verify with `git diff --stat` and use Write (full overwrite) as fallback
- Always verify current branch with `git branch --show-current` before committing — hooks/tools can switch branches

## Progress

- QA Audit completed 2026-02-06: 28 issues (9 critical, 5 high, 6 medium, 8 low) → docs/QA_AUDIT_2026-02-06.md
- PRD created: tasks/prd-qa-audit-fixes.md (21 user stories) + ralph/prd.json (15 Ralph-executable stories)
- C9 (Deep Search polling failure) documented; DS stories moved to ralph-ds/
- US-001 through US-003 completed in prior iterations
- US-004 completed: all remaining MCP contamination stripped
- US-005 completed: LargeRepo Dockerfiles pinned to specific commits

## 2026-02-06 - US-001
- Stripped all MCP/Sourcegraph references from 10 RepoQA instruction.md files
- Files changed: benchmarks/ccb_repoqa/tasks/*/instruction.md (all 10)
- Per file: removed "Use Sourcegraph MCP semantic search" step, "Sourcegraph MCP Tools You Should Use" section, "Use Sourcegraph MCP liberally" closing line
- Replaced step 2 with generic "Search the codebase" wording
- **Learnings for future iterations:**
  - The `tasks/` gitignore pattern matches at any depth — must use `git add -f` for benchmark task files
  - All 10 RepoQA files use identical template structure; batch edits via Python script are most reliable
  - The Edit tool can be fragile when making many parallel edits to files — Python scripts are more reliable for bulk changes
---

## 2026-02-06 - US-002
- Stripped all MCP/Sourcegraph references from 6 active TAC instruction.md files
- Files changed: benchmarks/ccb_tac/{tac-buffer-pool-manager,tac-dependency-change,tac-find-in-codebase-1,tac-find-in-codebase-2,tac-implement-hyperloglog,tac-write-unit-test}/instruction.md
- Per file: removed "**Why this benefits from MCP:**" bullet-list sections; removed MCP-advocacy Notes lines
- tac-find-in-codebase-1: also cleaned "Sourcegraph MCP excels at" from Description text and "Deep Search understands semantic queries" from Notes
- tac-find-in-codebase-2: also removed "Validates MCP advantage on git history search" note
- tac-write-unit-test: also removed "MCP helps find existing test patterns" note
- **Learnings for future iterations:**
  - Edit tool changes can be silently reverted by linter hooks — always verify with `git diff` before committing. Use Write tool (full file overwrite) when Edit gets reverted.
  - When switching branches, verify with `git branch --show-current` BEFORE committing — Write tool or hooks can silently switch branches
  - TAC has 8 directories but only 6 are active tasks (tac-copilot-arena-endpoint and tac-troubleshoot-dev-setup are not in the active set)
---

## 2026-02-06 - US-003
- Stripped all MCP/Sourcegraph references from 4 LargeRepo instruction.md files
- Files changed: benchmarks/ccb_largerepo/{big-code-k8s-001,big-code-servo-001,big-code-trt-001,big-code-vsc-001}/instruction.md
- Per file: removed "**Why this requires MCP:**" paragraph, "(use Sourcegraph MCP for broad search)" parenthetical from implementation steps, "**Why MCP Helps:**" footer line
- All task requirements and context preserved
- **Learnings for future iterations:**
  - LargeRepo files all use the same 3-location pattern for MCP refs: description paragraph, implementation step 1, and footer metadata
  - Branch switching can happen silently between `git branch --show-current` and `git commit` — always re-verify branch immediately before committing
  - The stash-checkout-pop workflow is needed to move between ralph branches since they have divergent file trees
---

## 2026-02-06 - US-004
- Stripped ALL remaining MCP/Sourcegraph references from instruction.md files across ALL benchmarks
- Files changed (771 total):
  - benchmarks/ccb_swebenchpro/template/instruction.md: removed "MCP Tools Available" section
  - benchmarks/ccb_swebenchpro/tasks/*/instruction.md (731 files): removed full "CRITICAL: Use Sourcegraph MCP Tools" section with SG preamble, replaced MCP-contaminated Guidelines with clean version
  - benchmarks/ccb_k8sdocs/pkg-doc-001/instruction.md: rewrote "Why this requires MCP" to "Why this requires cross-package context", removed Sourcegraph mention
  - benchmarks/ccb_k8sdocs/client-go-doc-001/instruction.md: removed trailing "Sourcegraph search provides this cross-package context efficiently."
  - benchmarks/ccb_pytorch/sgt-001/instruction.md: removed "(use Sourcegraph MCP if available)" from step 1
  - benchmarks/ccb_locobench/templates/instruction.md: removed "Step 2: Use Deep Search MCP for Code Discovery" section, renumbered steps
  - benchmarks/ccb_locobench/tasks/*/instruction.md (23 files): removed "Use MCP tools" instruction line, entire "MCP Search Instructions" section, renumbered remaining steps
  - benchmarks/ccb_repoqa/tasks/*/instruction.md (10 files): replaced "Use Sourcegraph MCP semantic search" with "Search the codebase", removed "Sourcegraph MCP Tools You Should Use" section, removed "Use Sourcegraph MCP liberally" line
  - benchmarks/ccb_tac/{tac-copilot-arena-endpoint,tac-troubleshoot-dev-setup}/instruction.md: cleaned 2 non-active TAC tasks
- Final verification: grep -ri across all ccb_*/*/instruction.md AND ccb_*/tasks/*/instruction.md returns 0 matches
- **Learnings for future iterations:**
  - SWE-bench Pro has 731+ generated task instruction.md files with baked-in SG preamble — these are separate from the template
  - Python bulk-edit scripts are essential for changes spanning hundreds of files
  - Branch switching between ralph branches can cause stash conflicts when both branches modified the same files
  - The `git checkout --ours` approach works for resolving conflicts when the current branch already has the correct version
---

## 2026-02-06 - US-005
- Pinned all 4 LargeRepo Dockerfiles to specific commits instead of `--depth 1` (which fetches whatever HEAD is)
- Files changed:
  - benchmarks/ccb_largerepo/big-code-k8s-001/environment/Dockerfile: pinned to tag `v1.30.0`
  - benchmarks/ccb_largerepo/big-code-servo-001/environment/Dockerfile: pinned to `be6a2f99a1e80060228f41280fd7d2178983e7ed` (main HEAD)
  - benchmarks/ccb_largerepo/big-code-trt-001/environment/Dockerfile: pinned to `b98f3fca2059f5403bee0966434578212bc92f32` (main HEAD)
  - benchmarks/ccb_largerepo/big-code-vsc-001/environment/Dockerfile: pinned to tag `1.96.0`
  - benchmarks/ccb_largerepo/big-code-servo-001/task.toml: pre_fix_rev updated from "main" to commit hash
  - benchmarks/ccb_largerepo/big-code-trt-001/task.toml: pre_fix_rev updated from "main" to commit hash
- Pattern: `git clone --filter=blob:none --no-checkout <url> .` + `git checkout <rev>` (per AC)
- **Learnings for future iterations:**
  - `--filter=blob:none --no-checkout` + `git checkout <tag>` is the correct pattern for pinned, space-efficient clones
  - Tags (v1.30.0, 1.96.0) are directly usable as checkout targets; branch names (main) must be resolved to commit hashes via `git ls-remote`
  - When task.toml has `pre_fix_rev = "main"`, update it to the actual commit hash used in the Dockerfile for consistency
  - instance_to_mirror.json was referenced in the PRD but doesn't exist on disk — SG mirror info lives in largerepo_3config.sh TASK_SG_REPO_NAMES
---

## 2026-02-06 - US-006
- Pinned LargeRepo SG repo names from `--latest` to commit-hash-suffixed names in largerepo_3config.sh
- Files changed:
  - configs/largerepo_3config.sh: Updated all 4 TASK_SG_REPO_NAMES entries from `--latest` to pinned commits
  - configs/sg_indexing_list.json: Added `largerepo` section with 4 repos, updated _total_repos from 18 to 22
- Mapping:
  - big-code-k8s-001: kubernetes--latest → kubernetes--7c48c2bd (v1.30.0, tag dereferenced to commit)
  - big-code-servo-001: servo--latest → servo--be6a2f99
  - big-code-trt-001: TensorRT-LLM--latest → TensorRT-LLM--b98f3fca
  - big-code-vsc-001: vscode--latest → vscode--138f619c (1.96.0 tag)
- **Learnings for future iterations:**
  - Kubernetes tags are annotated — `git ls-remote --tags` gives the tag object hash, must dereference with `^{}` suffix to get actual commit
  - VS Code tags are lightweight — commit hash comes directly from `git ls-remote`
  - The `sg_indexing_list.json` is the canonical registry of all sg-benchmarks repos; add new repos there when pinning
  - instance_to_mirror.json was created on a different branch (7cd5fdff) and never merged to this branch
---
