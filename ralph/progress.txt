# Ralph Progress Log
Started: Wed Feb 11 23:21:05 UTC 2026

## Codebase Patterns
- Result.json has TWO formats: (1) old format with `trials[]` array, (2) new flat format with `agent_execution`, `agent_result`, `verifier_result`, `exception_info` top-level keys
- Agent infra failures = agent_exec < 10s AND 0 output tokens. Genuine failures have tokens > 0.
- Rate limit errors show in claude-code.txt JSONL: `"text":"You've hit your limit · resets 4am (UTC)"` with `"error":"rate_limit"`
- Node.js version conflicts on Alpine: `apk add nodejs` won't upgrade pre-installed Node. Need `apk del nodejs npm` first. Also rm /usr/local/bin/node which shadows /usr/bin/node.
- Harbor `--path` mode uses local `environment/Dockerfile`; `--dataset` mode uses cached `~/.cache/harbor/tasks/*/environment/Dockerfile`. Fix BOTH for full coverage.
- Base image git state is sufficient — cached Dockerfile's `git reset --hard` is belt-and-suspenders. Test patches are applied by test.sh, not Dockerfile.
- Exception details live in `exception.txt` (not always present), `trial.log` (often empty), and `agent/claude-code.txt` (JSONL transcript — most reliable for error classification)
- 65536-byte `claude-code.txt` files are corrupted — contain minified JS bundle, not JSONL. Harbor bug when Claude Code crashes on startup.
- Infra failures cluster by batch timing (e.g., Feb 8-9 rate limits) not by task/repo.
- MANIFEST includes infra-fail results as reward=0.0, inflating failure rates.
- SWE-bench Pro Dockerfiles follow a standardized template: `FROM jefzda/sweap-images:{repo_tag}` + uv install + Harbor dirs. Environment issues are in base images, not Dockerfiles.
- All 7 non-protonmail SWE-bench Pro repos have confirmed healthy Docker environments. Only protonmail needed a fix.
- For re-runs, use `--single-account` when multi-account tokens are expired. Primary $HOME token lasts ~8h, enough for ~34 sequential tasks.
- Always match the original run's model (opus) and config — don't use haiku or different environments for fill-in runs.

---

## 2026-02-11 - US-001
- Diagnosed all SWE-bench Pro errored task runs across 8 repos
- Found 42 infra failures (not 29 as PRD estimated) across active non-archived runs
- Root causes classified:
  - 25 rate limit hits ("You've hit your limit · resets 4am (UTC)") — subscription exhausted during Feb 8-9 batch
  - 10 Node.js version conflict (protonmail only) — Alpine base image has Node 16, Claude Code needs 18+
  - 4 agent setup timeout (archived protonmail runs) — chown hangs on large workspace
  - 3 transcript corruption (internetarchive SG_full) — 65KB minified JS dump instead of JSONL
- Key finding: Most failures are NOT Docker build issues. Only protonmail needs a Docker fix.
- Files changed: docs/swebenchpro_docker_diagnosis.md (new), ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Don't assume errored tasks are Docker failures — always check claude-code.txt transcript for the real error
  - Rate limit failures are batch-timing issues, not task-specific. Same tasks pass in different batches.
  - The `result.json` error field is often empty for infra failures — need to read multiple log sources
  - Two result.json formats exist (trials[] vs flat) depending on Harbor version
  - `__archived_invalid` directories contain historical failures but most lack useful error detail
---

## 2026-02-11 - US-002
- Fixed protonmail Docker environment (Node.js v16→v18 upgrade)
- Root cause: Base images (`jefzda/sweap-images:protonmail.webclients-*`) have Node 16 at `/usr/local/bin/node` which shadows Alpine's Node 18 at `/usr/bin/node`
- Fix: `apk del nodejs nodejs-current npm` + `rm -f /usr/local/bin/node` + `apk add --no-cache nodejs npm`
- Applied to 8 Dockerfiles: 4 local (`benchmarks/ccb_swebenchpro/tasks/instance_protonmail-webclients-*/environment/Dockerfile`) + 4 Harbor cached (`~/.cache/harbor/tasks/*/instance_protonmail__webclients-*/environment/Dockerfile`)
- Verification: all 8 images build, Node v18.20.1 confirmed, Claude Code installs without EBADENGINE warnings
- Files changed: 4 Harbor cached Dockerfiles (local Dockerfiles already had the fix from a prior session), docs/swebenchpro_docker_diagnosis.md (updated), ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Alpine Node.js PATH precedence: `/usr/local/bin` beats `/usr/bin`. Must remove old binaries explicitly.
  - Harbor uses different Dockerfiles for `--path` vs `--dataset` mode. Always patch both.
  - The `|| true` on curl for uv install is intentional — Alpine images lack curl; uv is optional.
  - Test patches are applied by `test.sh` via `git apply`, NOT by the Dockerfile. The cached Dockerfile's `git checkout -- <files>` is for SWE-bench's own test setup (different mechanism).
---

## 2026-02-11 - US-003
- Assessed all 7 non-protonmail repo Docker environments (qutebrowser, teleport, vuls, element-hq, tutanota, nodebb, internetarchive)
- **Result: No Docker fixes needed.** All environments build and run correctly.
- All 32 infra failures are OAuth rate-limit hits with identical signature: 0 output tokens, 0-8s agent execution, clustered in Feb 8-9 batch window
- Per-repo Docker health confirmed:
  - qutebrowser: 6 pass / 0 fail / 6 infra-error
  - teleport: 5 pass / 3 fail / 6 infra-error (3 fails are genuine task difficulty)
  - vuls: 5 pass / 3 fail / 3 infra-error
  - element-hq: 5 pass / 0 fail / 1 infra-error
  - tutanota: 1 pass / 0 fail / 2 infra-error
  - nodebb: 8 pass / 4 fail / 1 infra-error
  - internetarchive: 21 pass / 0 fail (archived) / 4 active infra-error
- All Dockerfiles follow identical healthy template (jefzda/sweap-images base + uv install + Harbor dirs)
- Generated re-run plan: ~33 rate-limit-recovery runs + 12 protonmail Docker-fix runs = ~45 total
- Files changed: docs/swebenchpro_docker_diagnosis.md (updated with US-003 Assessment section), ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - SWE-bench Pro tasks use a standardized Dockerfile template — all environment issues are in the base images, not the Dockerfiles
  - When PRD says "fix Docker environments", first verify Docker is actually broken — it's often auth/rate-limit instead
  - infra failures cluster by batch timing, not by repo. If one task in a batch fails with 0 tokens, check siblings.
  - "Unfixable" column in acceptance criteria is empty — all SWE-bench Pro environments are runnable
---

## 2026-02-12 - US-004
- Re-ran 34 task-config pairs (13 BL + 16 SG_base + 5 SG_full) that previously had infra failures
- Created `configs/swebenchpro_rerun_infra_failures.sh` — dedicated re-run script with --path/--dataset mode selection, SG repo mapping, single-account mode
- Run dir: `runs/official/swebenchpro_rerun_opus_20260211_235834/`
- Results:
  - Baseline: 9/13 passed (69%), 4 genuine failures (teleport-7744, teleport-8302, openlibrary-92db, qutebrowser-394b)
  - SG_base: 13/16 passed (81%), 2 genuine failures, 1 Docker error (nodebb-eb49a649)
  - SG_full: 3/5 passed (60%), 1 genuine failure (openlibrary), 1 token refresh error (protonmail-8be4)
  - Total: 25/34 passed (73.5%), 7 genuine failures, 2 remaining infra errors
- MANIFEST scores improved dramatically:
  - BL: 0.390 → 0.771 (was inflated by 13 zero-reward infra failures)
  - SG_base: 0.317 → 0.765 (16 zeros removed)
  - SG_full: 0.694 → 0.824 (5 zeros/missing removed)
- All 4 protonmail tasks passed in baseline (100%) — Docker fix from US-002 confirmed working
- Protonmail SG configs: 7/8 passed (1 token refresh 403 error in SG_full)
- openlibrary-92db3454 confirmed as genuine hard failure (failed all 3 configs)
- Two remaining errors need separate fix:
  - nodebb-eb49a649 SG_base: Docker compose startup failure (may need Dockerfile investigation)
  - protonmail-8be4 SG_full: token refresh 403 (auth timing issue, would succeed on rerun)
- Files changed: configs/swebenchpro_rerun_infra_failures.sh (new), ralph/swebenchpro_rerun_plan.json (new), ralph/prd.json, ralph/progress.txt
- **Learnings for future iterations:**
  - Single-account mode works fine for sequential runs when multi-account tokens are expired
  - The PRD assumed haiku model + daytona env, but the actual benchmark uses opus + default Docker — always match the original run config
  - --path mode gap-fill tasks take longer (Docker build from scratch) vs --dataset (cached images)
  - Token refresh 403 during a long run is recoverable — the agent re-reads the refreshed credentials file
  - SG_base outperformed baseline on these reruns (81% vs 69%) — MCP particularly helped with qutebrowser and element-web tasks
---
