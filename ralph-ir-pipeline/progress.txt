## Codebase Patterns

### IR Metrics Module (scripts/ccb_metrics/ir_metrics.py)
- IRScores dataclass holds per-task metrics: mrr, map_score, file_recall, context_efficiency, ttfr, tt_all_r, n_steps_to_first, plus @k dicts (precision, recall, f1, ndcg)
- compute_ir_scores() takes (retrieved, ground_truth_files, task_id, config_name) → IRScores
- aggregate_ir_scores() takes list[IRScores] → dict with mean/std/median/n for each metric
- extract_time_to_context() joins trajectory.json timestamps with claude-code.txt file paths via tool_use_id; falls back to synthesize_trajectory() when trajectory.json missing
- synthesize_trajectory() parses claude-code.txt JSONL, extracts tool_use blocks, estimates timestamps at _CALIBRATION_SECS_PER_STEP=2.6s/step
- _normalize() strips leading slashes, /workspace/ prefix for path comparison
- Trajectory regex: _TOOL_EXEC_RE = re.compile(r"Executed (\S+) (toolu_\S+)")

### IR Analysis Script (scripts/ir_analysis.py)
- run_ir_analysis() is the main orchestrator: loads ground truth, scans run dirs, computes scores, runs stats
- format_table() generates ASCII output; add format_report_markdown() for --report
- SKIP_PATTERNS = {"archive", "__broken_verifier", "validation_test", "preamble_test_"}
- DROPPED_BENCHMARKS = {"ccb_dependeval", "ccb_locobench"}
- _infer_suite() maps task_id patterns to suite names (15+ patterns)
- Statistical tests use ccb_metrics.statistics: welchs_t_test, cohens_d, bootstrap_ci

### Ground Truth (scripts/ccb_metrics/ground_truth.py)
- Per-benchmark extraction functions: _gt_swebenchpro, _gt_pytorch, _gt_k8s_docs, etc.
- TaskGroundTruth dataclass: task_id, benchmark, files, source, confidence
- K8s Docs and TAC use hardcoded dicts (manual ground truth)
- Cache at configs/ground_truth_files.json (rebuild with --build-ground-truth)

### Run Directory Structure
- runs/official/ is a symlink to /home/stephanie_jarmak/evals/custom_agents/agents/claudecode/runs/official
- Layout: runs/official/{run_dir}/{config}/{batch_timestamp}/{task__hash}/
- Files per task: result.json, agent/claude-code.txt, agent/trajectory.json, task_metrics.json
- MANIFEST.json at runs/official/MANIFEST.json — keyed by (run_name, task_name, config)

### Existing Statistics Module (scripts/ccb_metrics/statistics.py)
- welchs_t_test(a, b) → dict with t_stat, p_value, df, is_significant (alpha=0.05)
- cohens_d(a, b) → dict with d, magnitude, ci_lower, ci_upper
- bootstrap_ci(deltas) → dict with estimate, ci_lower, ci_upper
- mcnemar_test(pairs) → dict for pass/fail contingency

### Token Data
- task_metrics.json has: input_tokens, output_tokens, cache_creation_tokens, cache_read_tokens, agent_task_time_seconds
- Extracted by scripts/reextract_all_metrics.py from claude-code.txt JSONL
- Cost model: input at $15/M, output at $75/M tokens

### Config Labels (from compare_configs.py)
- TIER_LABELS = {"baseline": "IDE-native", "sourcegraph_base": "SG_base", "sourcegraph_full": "Context infra"}

## Progress

## 2026-02-16 - US-001
- Implemented `synthesize_trajectory()` in scripts/ccb_metrics/ir_metrics.py
- Modified `extract_time_to_context()` to fall back to synthesis when trajectory.json is missing or empty
- Calibration: median 2.6s/step from 1347 intervals across 31 paired runs
- Coverage: 753 real trajectory.json, 4 newly synthesized, 9 no usable data (empty transcripts)
- Files changed: scripts/ccb_metrics/ir_metrics.py
- **Learnings for future iterations:**
  - claude-code.txt JSONL has `type` field: system, assistant, user. Tool uses are in assistant message.content blocks with type=tool_use
  - trajectory.json uses _TOOL_EXEC_RE pattern "Executed ToolName toolu_xxx" in step messages — synthesized steps must match this format exactly
  - Protonmail/internetarchive tasks have empty/corrupt transcripts (65KB but only 1 line) — these are legitimate "no data" cases, not synthesis failures
  - `datetime.timedelta` is more reliable than manual string formatting for ISO timestamps
  - The 27 missing trajectory.json cases (3.4% of 798) are concentrated in SWE-bench Pro gapfill, PyTorch paired, and LinuxFLBench runs
---
