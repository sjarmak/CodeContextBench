## Codebase Patterns
- codereview tasks clone target repos (Ghost, aspnetcore, cal.com) and inject defects via Dockerfile patches
- Hybrid scoring: 0.5 * detection_F1 + 0.5 * fix_score, output to /logs/verifier/reward.txt
- Agent dual output: code fixes committed to workspace + /workspace/review.json structured review
- Ground truth in tests/expected_defects.json and tests/expected_patches/
- DIR_PREFIX_TO_SUITE mapping needed in both generate_manifest.py and aggregate_status.py
- Ghost PR #26260 (comment likes): merge commit b43bfc85, 10 files, pinned for cr-ghost-001
- inject_defects.sh uses Python regex for multi-line code transformations (more reliable than sed)
- Harbor build context is the TASK ROOT directory (not environment/) — COPY paths must be relative to task root

## Progress

## 2026-02-06 - US-001
- Added `"codereview_": "ccb_codereview"` to DIR_PREFIX_TO_SUITE in scripts/generate_manifest.py
- Files changed: scripts/generate_manifest.py (new file from earlier commit, plus codereview entry)
- **Learnings for future iterations:**
  - generate_manifest.py doesn't exist on main — it was added in the bulk infrastructure commit (2bb664a7), not the scaffold commit
  - The scaffold commit (0483b714) has massive merge conflicts with main — cherry-picking is not viable. Use `git show <commit>:<path>` to extract individual files instead
  - Dict entries in DIR_PREFIX_TO_SUITE are alphabetically ordered
---

## 2026-02-06 - US-002
- Added `"codereview_": "ccb_codereview"` to DIR_PREFIX_TO_SUITE in scripts/aggregate_status.py
- Extracted aggregate_status.py and its dependency status_fingerprints.py from scaffold commit (0483b714) since neither existed on working tree
- Files changed: scripts/aggregate_status.py (new), scripts/status_fingerprints.py (new)
- **Learnings for future iterations:**
  - aggregate_status.py imports status_fingerprints.py — both must be extracted together from the scaffold commit
  - Same `git show <commit>:<path>` pattern used as for generate_manifest.py in US-001
  - Dict entry added in alphabetical position (after crossrepo, before dibench)
---

## 2026-02-06 - US-003
- Created ground truth defects for cr-ghost-001 based on Ghost PR #26260 (comment likes feature)
- Selected merge commit b43bfc85b719ab3971b83b5ef954601bf2d95fbf (10 files changed)
- 4 defects across 3 backend files: comments-service.js (2), comments-controller.js (1), comment-likes.js (1)
- Types: 3 functional bugs (critical/high) + 1 compliance violation (medium)
- Files changed: expected_defects.json, 4 expected patch files, inject_defects.sh
- Also extracted scaffold files (task.toml, instruction.md, Dockerfile, test.sh) from commit 0483b714
- **Learnings for future iterations:**
  - `git checkout <commit> -- <path>` is cleaner than `git show` for extracting whole directories — auto-stages files
  - Ghost PR #26260 adds a full API endpoint stack (route → endpoint → controller → service) — ideal for cross-layer defect injection
  - inject_defects.sh uses Python regex for reliable multi-line block removal (sed is fragile for this)
  - Defect injection must be idempotent — each script section operates independently
  - Patch files use unified diff format for human readability but test.sh will use pattern matching, not git apply
---

## 2026-02-06 - US-004
- Replaced all TODO placeholders in cr-ghost-001/instruction.md with concrete task specification
- Instruction covers: PR context (Ghost comment likes, 3 backend files), defect types (functional bugs + compliance violations), dual output (code fixes + review.json), hybrid scoring formula
- 3129 characters (well above 500 char preflight threshold)
- Files changed: benchmarks/ccb_codereview/cr-ghost-001/instruction.md
- **Learnings for future iterations:**
  - instruction.md should specify exact JSON output format with field names — agents perform better with explicit schemas
  - Including file paths in the instruction helps agents scope their review (don't leave them searching the entire repo)
  - Scoring explanation helps agents optimize their approach (detection + fixes, not just one)
---

## 2026-02-06 - US-005
- Replaced placeholder scoring in cr-ghost-001/tests/test.sh with hybrid scoring
- Detection scoring (50%): parses /workspace/review.json, matches by file path against expected_defects.json, computes precision/recall/F1
- Fix scoring (50%): checks 4 defect-specific code patterns in agent's modified files (NotFoundError guard, frame.options.id, cacheInvalidate, member relation)
- Final score = 0.5 * F1 + 0.5 * fix_score, written to /logs/verifier/reward.txt
- Uses inline python3 heredoc (no jq dependency needed)
- Files changed: benchmarks/ccb_codereview/cr-ghost-001/tests/test.sh
- **Learnings for future iterations:**
  - Inline python3 heredoc in bash (<<'PYEOF') is cleaner than jq for complex JSON+logic scoring
  - File-path matching with suffix comparison handles agents that use absolute vs relative paths
  - Fix pattern matching should check distinctive keywords, not exact line content — agents may format code differently
  - Print diagnostics to stderr so stdout only has the score (captured by bash $())
---

## 2026-02-06 - US-006
- Updated cr-ghost-001 Dockerfile to clone TryGhost/Ghost instead of benchmark-pr-mapping
- Pinned commit: b43bfc85b719ab3971b83b5ef954601bf2d95fbf (PR #26260 merge commit)
- Added python3 to apt-get (needed by inject_defects.sh)
- Dockerfile now: clones Ghost → runs inject_defects.sh → copies ground truth to /workspace/tests/
- Files changed: benchmarks/ccb_codereview/cr-ghost-001/environment/Dockerfile
- **Learnings for future iterations:**
  - Harbor build context is the TASK ROOT directory, not environment/ — so COPY paths must be relative to task root (e.g., `COPY environment/inject_defects.sh` not `COPY inject_defects.sh`)
  - Use `--filter=blob:none --no-checkout` for large repos — avoids downloading blobs until checkout
  - Set git user.email/user.name after clone so agents can commit fixes
  - `docker build --check` validates Dockerfile syntax without executing (no network needed)
---

## 2026-02-06 - US-007
- Updated cr-ghost-001 task.toml `repo` from "benchmark-pr-mapping" to "Ghost"
- Added cr-ghost-001 entry to configs/selected_benchmark_tasks.json with `repo: "TryGhost/Ghost"`
- Fixed pre-existing trailing commas in selected_benchmark_tasks.json (strict JSON parser was failing)
- Files changed: benchmarks/ccb_codereview/cr-ghost-001/task.toml, configs/selected_benchmark_tasks.json
- **Learnings for future iterations:**
  - selected_benchmark_tasks.json had trailing commas (invalid JSON) — probably written by hand or a lenient generator. Always validate after editing.
  - Python `re.sub(r',(\s*[}\]])', r'\1', content)` is a reliable way to strip trailing commas from JSON
  - task.toml uses short repo name ("Ghost"), selected_benchmark_tasks.json uses full GitHub org/repo ("TryGhost/Ghost") — different conventions
---
